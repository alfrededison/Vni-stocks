<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>VNStock - VN30</title>
    <style>
        table {
            border-collapse: collapse;
            border-spacing: 0;
            width: 100%;
            border: 1px solid #ddd;
        }

        th,
        td {
            text-align: left;
            padding: 16px;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
</head>

<body>
    <main>
        <section id="vn30f1m">
            <h2>Signal table</h2>
            <div>Last trigger: {{ last_triggered }}</div>
            {{ vn30f1m|safe }}

            <h2>Signal Chart</h2>
            <div id="chart" style="height:1000px;"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Hieu Nguyen. All rights reserved.</p>
    </footer>
    <script>
        const data = JSON.parse('{{ data | safe }}');
        function drawCharts() {
            if (!data.length) return;

            // Prepare data
            const times = data.map(d => d.time);
            const open = data.map(d => +d.open);
            const high = data.map(d => +d.high);
            const low = data.map(d => +d.low);
            const close = data.map(d => +d.close);
            const volume = data.map(d => +d.volume);
            const sma_1 = data.map(d => d.sma ? +d.sma : null);
            const ema_1 = data.map(d => d.ema ? +d.ema : null);
            const rsi_1 = data.map(d => d.rsi ? +d.rsi : null);
            const ma_rsi_1 = data.map(d => d.ma_rsi ? +d.ma_rsi : null);
            const buy = data.map(d => d.Buy);
            const sell = data.map(d => d.Sell);

            // OHLC, SMA, EMA traces
            const ohlc = {
                x: times,
                open, high, low, close,
                type: 'candlestick',
                name: 'OHLC',
                yaxis: 'y1'
            };
            const sma = {
                x: times,
                y: sma_1,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 5',
                line: { color: 'orange', width: 1.5 },
                yaxis: 'y1'
            };
            const ema = {
                x: times,
                y: ema_1,
                type: 'scatter',
                mode: 'lines',
                name: 'EMA 3',
                line: { color: 'blue', width: 1.5 },
                yaxis: 'y1'
            };
            // Volume overlay (on y2)
            const vol = {
                x: times,
                y: volume,
                type: 'bar',
                name: 'Volume',
                yaxis: 'y2',
                marker: { color: 'rgba(100,100,200,0.3)' },
                opacity: 0.5
            };
            // RSI and MA-RSI (on y3)
            const rsi_trace = {
                x: times,
                y: rsi_1,
                type: 'scatter',
                mode: 'lines',
                name: 'RSI',
                line: { color: 'green', width: 1.5 },
                yaxis: 'y3'
            };
            const marsi_trace = {
                x: times,
                y: ma_rsi_1,
                type: 'scatter',
                mode: 'lines',
                name: 'MA-RSI',
                line: { color: 'red', width: 1.5 },
                yaxis: 'y3'
            };

            // Find buy/sell indices and positions
            const buyIndices = buy.map((b, i) => b ? i : -1).filter(i => i !== -1);
            const sellIndices = sell.map((s, i) => s ? i : -1).filter(i => i !== -1);

            const buy_x = buyIndices.map(i => times[i]);
            const buy_y = buyIndices.map(i => low[i] - (high[i] - low[i]) * 0.03); // a bit below the low

            const sell_x = sellIndices.map(i => times[i]);
            const sell_y = sellIndices.map(i => high[i] + (high[i] - low[i]) * 0.03); // a bit above the high

            const buy_arrows = {
                x: buy_x,
                y: buy_y,
                mode: 'markers',
                name: 'Buy',
                yaxis: 'y1',
                marker: {
                    symbol: 'arrow-up',
                    color: 'green',
                    size: 18,
                    line: { width: 1, color: 'black' }
                },
                type: 'scatter'
            };

            const sell_arrows = {
                x: sell_x,
                y: sell_y,
                mode: 'markers',
                name: 'Sell',
                yaxis: 'y1',
                marker: {
                    symbol: 'arrow-down',
                    color: 'red',
                    size: 18,
                    line: { width: 1, color: 'black' }
                },
                type: 'scatter'
            };

            Plotly.newPlot('chart', [ohlc, sma, ema, vol, buy_arrows, sell_arrows, rsi_trace, marsi_trace], {
                title: 'VN30F1M Chart',
                grid: { rows: 1, columns: 1 },
                xaxis: {
                    title: 'Time',
                    type: 'category',
                    rangeslider: { visible: false },
                    anchor: 'y3',
                    tickangle: -45,
                    automargin: true,
                    showgrid: true, 
                    gridcolor: '#eee', 
                },
                yaxis: {
                    title: 'Price',
                    domain: [0.3, 1],
                    side: 'right'
                },
                yaxis2: {
                    title: 'Volume',
                    overlaying: 'y',
                    side: 'left',
                    showgrid: false,
                    domain: [0.3, 1]
                },
                yaxis3: {
                    title: 'RSI',
                    domain: [0, 0.3],
                    side: 'right',
                    range: [0, 100]
                },
                shapes: [
                    // RSI 30 line
                    {
                        type: 'line',
                        xref: 'paper',
                        x0: 0, x1: 1,
                        yref: 'y3',
                        y0: 30, y1: 30,
                        line: { color: 'gray', width: 0.5, dash: 'dash' }
                    },
                    // RSI 70 line
                    {
                        type: 'line',
                        xref: 'paper',
                        x0: 0, x1: 1,
                        yref: 'y3',
                        y0: 70, y1: 70,
                        line: { color: 'gray', width: 0.5, dash: 'dash' }
                    }
                ],
            });
        }
        drawCharts();
    </script>
</body>

</html>